---
title: "Análise de Vinhos Tintos"
author: "Jader Martins"
date: "15 de Dezembro, 2017"
output:
  html_document:
    df_print: paged
---

<style>
  <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet"> 
  pre{
    background-color: #ececec !important;
  }
  body{
    background-color: #323232 !important;
    color: #f6f6f6 !important;
    font-family: 'Inconsolata', monospace;
  }
  h1{
    font-size: 48px !important;
    color: #f75940 !important
  }
</style>

#### O projeto

Neste projeto, você irá usar o R e aplicar técnicas de análise exploratória de dados para verificar relações em uma ou mais variáveis e explorar um conjunto de dados específico para encontrar distribuições, outliers e anomalias.

Análise Exploratório de dados (Exploratory Data Analysis, ou EDA) é a análise numérica e visual das características de dados e seus relacionamentos usando métodos formais e estratégias estatísticas.

EDA pode nos trazer insights, que podem nos levar a novas questões, e eventualmente a modelos preditivos. É uma importante "linha de defesa" contra dados ruins e uma oportunidade de comprovar se suas suposições ou intuições sobre um conjunto estão sendo violadas.

## Introdução

Essa análise irá explorar um conjunto de dados de vinhos tintos [Cortez et al., 2009], originalmente construído para modelagem da qualidade do vinho refletida por aspectos químicos de cada bebida. Obtive a ajuda de um amigo formado em química para me guiar em possíveis aspectos quimícos que podem gerar um gosto desagradável no vinho, e sob essas hipoteses guiarei minha analise.


```{r global_options, include = FALSE}
# setting global options for all code chunks
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r packages}
library(GGally)
library(memisc)
library(RColorBrewer)
library(ggplot2)
library(gridExtra)
library(knitr)
```

```{r Load_the_Data}
# Load the Data
wine <- read.csv('wineQualityReds.csv')
```

# Seção de Gráficos Univariados

## Visão Geral

Para iniciar iremos analisar cada variável separadamente para termos uma ideia do que estamos lidando:

```{r Univariate_Plots}
summary(wine)
```
```{r}
str(wine)
```
Podemos ver que os dados estão bem formatados e embora algumas colunas aparentem ter outliers nada parece fora do normal.

Primeiro removemos a coluna de index que não é necessária.

```{r}
wine$X <- NULL
```

## Qualidade

```{r}
# Como iremos criar varios histogramas irei criar uma função para facilitar isso.

hist_plot <- function(data, x, binwidth) {
  ggplot(data = data, aes_string(x = x)) +
   geom_histogram(binwidth = binwidth)
}
```

Começaremos pela variável qualidade:

```{r}
hist_plot(wine, 'quality', 1) +
  scale_x_continuous(breaks = c(min(wine$quality):max(wine$quality)))
```

Embora tenhamos notas possiveis de 0 a 10 os dados apresentam notas apenas no intervalo 3-8 com pico no 5 e poucos exemplos nos extremos, olharemos de forma mais detalhada:

Vinhos piores:

```{r}
nrow(subset(wine, quality <= 4))
```
Vinhos melhores:

```{r}
nrow(subset(wine, quality >= 7))
```

Apenas 18 vinhos receberam a nota mais alta dos jurados e os de qualidade baixa também se encontram com pouca representatividade, iremos voltar a essa analise posteriormente.

## Álcool

Agora analisaremos a quantidade de álcool.

```{r}
hist_plot(wine, 'alcohol', .2) +
  scale_x_continuous(breaks = seq(min(wine$alcohol), max(wine$alcohol), .4))
```

A quantidade de álcool mais comum está por volta de 9.4, com uma distribuição bem irregular (talvez uma binormal), talvez seja interessante criar subconjuntos das diferentes qualidades de vinhos para analisar melhor.

```{r}
h1_a <- hist_plot(subset(wine, quality <= 4), 'alcohol', .2) +
  scale_x_continuous(breaks = seq(min(wine$alcohol), max(wine$alcohol), .4)) +
  ggtitle('Porcentagem de alcool nos vinhos ruins')

h2_a <- hist_plot(subset(wine, quality >= 7), 'alcohol', .2) +
  scale_x_continuous(breaks = seq(min(wine$alcohol), max(wine$alcohol), .4)) +
  ggtitle('Porcentagem de alcool nos vinhos bons')

grid.arrange(h1_a, h2_a)
```

Não está muito claro devido a baixa amostragem de dados para binhos bons mas aparenta que vinhos melhores tenham mais álcool que vinhos ruins, suponho que pelo tempo de fermentação que vinhos melhores levam eles acumulam mais alcool, mas para ter mais confiança dessa afirmação é necessário uma analise de regressão.

## Açúcar residual

Agora analisaremos o açúcar residual dos nossos vinhos contém.

```{r}
hist_plot(wine, 'residual.sugar', 2)
```

Com uma distribuição de cauda pesada devemos setar aumentar a precisão no eixo x e aumentar a quantidade de barras para visualizar melhor.

```{r}
hist_plot(wine, 'residual.sugar', .25) +
  scale_x_continuous(breaks = seq(1, 22, 1)) +
  coord_cartesian(xlim = c(min(wine$residual.sugar), 22))
```

Existe um pico ao redor do 2, vamos analisar essa região.

```{r}
hist_plot(wine, 'residual.sugar', .1) +
  scale_x_continuous(breaks = seq(1.5, 2.5, .1)) +
  coord_cartesian(xlim = c(1, 3))
```

Neste intervalo os dados parecem estar distribuidos de forma normal, sendo onde a maioria dos vinhos se encontram, para as outras regiões talvez encontremos outliers quanto a qualidade do vinho, vinhos muito doces tendem a ser considerados ruins.

Agora voltemos a analisar a distruibuição de cauda pesada, para isso renormalizamos aplicando uma scala logaritmica.

```{r}
hist_plot(wine, 'residual.sugar', .1) +
  scale_x_log10(breaks = seq(0, 10, 1))
```

Bem melhor, agora podemos ver um mini pico para os dados acima de 10.

Vamos analisar agora o açúcar residual nos vinhos outliers:

```{r}
h1_s <- hist_plot(subset(wine, quality <= 4), 'residual.sugar', 1) +
  scale_x_continuous(breaks = seq(1, max(wine$residual.sugar))) +
  ggtitle('Quantidade de açúcar residual em vinhos ruins')

h2_s <- hist_plot(subset(wine, quality >= 7), 'residual.sugar', 1) +
  scale_x_continuous(breaks = seq(1, max(wine$residual.sugar))) +
  ggtitle('Quandidade de açúcar residual em vinhos bons')

grid.arrange(h1_s, h2_s)
```

As modas estão em 2 porém os vinhos ruins possuem outliers a muitos desvios padrões da média (13), e as distribuições são de cauda pesada.

## Cloretos

Cloretos indicam a salinidade no vinhos, não podendo conter em excesso, estragando o vinho.

```{r}
hist_plot(wine, 'chlorides', .005)
```

Aqui também com cauda pesada iremos aplicar a transformação log.

```{r}
hist_plot(wine, 'chlorides', .025) +
  scale_x_log10(breaks = seq(.01, .09, .02))
```

Como é visivel, existe uma grande acumulação entre 0.07 e 0.09, e outliers a esquerda e direita.

Vejamos como eles desempenham:

```{r}
subset(wine, chlorides == min(wine$chlorides))
```
```{r}
subset(wine, chlorides == max(wine$chlorides))
```
Os de pouca salinidade tiveram notas altas, interessante.

## pH

Vemos agora o pH que descreve a acidez/basicidade do vinho na escala de 0 a 14.

```{r}
hist_plot(wine, 'pH', .1) +
  scale_x_continuous(breaks = seq(min(wine$pH), max(wine$pH), .1))
```

Aqui vemos uma distribuição normal e bem centrada, vejamos a relação com a qualidade dos vinhos.

```{r}
h1_ph <- hist_plot(subset(wine, quality <= 4), 'pH', .05) +
  ggtitle('pH nos vinhos ruins')

h2_ph <- hist_plot(subset(wine, quality >= 7), 'pH', .05) +
  ggtitle('pH nos vinhos bons')

grid.arrange(h1_ph, h2_ph)
```

Não é visivel nenhuma diferença significativa entre os vinhos.

## Densidade

A densidade depende da quantidade de alcool e açucar residual, vejamos como está essa distribuição.

```{r}
hist_plot(wine, 'density', .001)
```

Nada fora do comum por aqui, mas vejamos como está em relação a qualidade.

```{r}
h1_d <- hist_plot(subset(wine, quality <= 4), 'density', .001) +
  ggtitle('Densidade de vinhos ruins')

h2_d <- hist_plot(subset(wine, quality >= 7), 'density', .001) +
  ggtitle('Densidade de vinhos bons')

grid.arrange(h1_d, h2_d)
```

Não há uma separação significativa entre as distribuições.

## Ácido citrico

Uma das principais caracteristicas do sabor do vinho, talvez a mais interessante dos dados.

```{r}
hist_plot(wine, 'citric.acid', .01) +
  scale_x_continuous(breaks = seq(min(wine$citric.acid), 1, .1))
```

Os dados estão com uma distribuição muito estranha, não sendo claro alguma forma de analisa-los, mas como esperado é uma caracteristica distoante entre os vinhos. Vejamos mais de perto entre os picos:

```{r}
hist_plot(wine, 'citric.acid', .01) +
  scale_x_continuous(breaks = seq(min(wine$citric.acid), .75, .05)) +
  coord_cartesian(xlim = c(min(wine$citric.acid), .75))
```

Vamos ver agora a concentração para vinhos bons e ruins separadamente:

```{r}
h1_ca <- hist_plot(subset(wine, quality <= 4), 'citric.acid', .05) +
  ggtitle('Vinhos ruins')

h2_ca <- hist_plot(subset(wine, quality >= 7), 'citric.acid', .05) +
  ggtitle('Vinhos bons')

grid.arrange(h1_ca, h2_ca)
```

Para os vinhos ruins está uma cauda pesada com centro a esquerda e esparsa, ja para os vinhos bons uma distribuição talvez binormal. 

## Sulfatos

Sulfatos são adicionados ao vinho para controlar aspectos na fabricação, não interferindo muito no produto final.

```{r}
hist_plot(wine, 'sulphates', .01)
```

Com cauda pesada novamente iremos aplicar uma transformação log.

```{r}
hist_plot(wine, 'sulphates', .01) +
  scale_x_log10(breaks = seq(min(wine$sulphates), .8, .05))
```

Agora temos um histograma mais centralizado com varios picos e alguns outliers, acredito que tais picos sejam dados pelo arrendondamento já que estamos em um intervalo pequeno.

Novamente analisando em relação a vinhos bons e ruins.

```{r}
h1_sul <- hist_plot(subset(wine, quality <= 4), 'sulphates', .05) +
  ggtitle('Vinhos ruins')

h2_sul <- hist_plot(subset(wine, quality >= 7), 'sulphates', .05) +
  ggtitle('Vinhos bons')

grid.arrange(h1_sul, h2_sul)
```

Vinhos ruins estão com outliers com valores bem altos, talvez isso colabore na pessima nota.

## Acidez fixada e volatil

Aqui analisamos a acidez volatil, em excesso pode deixar o vinho com gosto de vinagre.

```{r}
hist_plot(wine, 'fixed.acidity', .25)
```

Para essa distribuição temos varios outliers de valores bem altos, acredito que esses vinhos tenham recebido nota ruim, valor analisar:

```{r}
h1_fa <- hist_plot(subset(wine, quality <= 4), 'fixed.acidity', .5) +
  scale_x_continuous(breaks = seq(min(wine$fixed.acidity), max(wine$fixed.acidity), .5)) +
  ggtitle('Vinhos ruins')

h2_fa <- hist_plot(subset(wine, quality >= 7), 'fixed.acidity', .5) +
  scale_x_continuous(breaks = seq(min(wine$fixed.acidity), max(wine$fixed.acidity), .5)) +
  ggtitle('Vinhos bons')

grid.arrange(h1_fa, h2_fa)
```

Pelo gráfico podemos ver que isso não é um fator determinante na qualidade do vinho, sendo as distribuições pertencendo ao mesmo intervalo.

Agora para acidez volatil:

```{r}
hist_plot(wine, 'volatile.acidity', .01) +
  scale_x_continuous(breaks = seq(min(wine$volatile.acidity), max(wine$volatile.acidity), .1))
```

A distribuição está bem inregular e acredito que novamente seja pelo truncamento, agora as distribuições para vinhos bons e ruins.

```{r}
h1_va <- hist_plot(subset(wine, quality <= 4), 'volatile.acidity', .06) +
  scale_x_continuous(breaks = seq(min(wine$volatile.acidity), max(wine$volatile.acidity), .1)) +
  ggtitle('Vinhos ruins')

h2_va <- hist_plot(subset(wine, quality >= 7), 'volatile.acidity', .06) +
  scale_x_continuous(breaks = seq(min(wine$volatile.acidity), max(wine$volatile.acidity), .1)) +
  ggtitle('Vinhos bons')

grid.arrange(h1_va, h2_va)
```

A distribuição para vinhos bons parece que foi deslizada a esqueda e menos espaçada

## Dioxido de enxofre

Comecemos a analise do SO2 pelo enxofre livre:

```{r}
hist_plot(wine, 'free.sulfur.dioxide', 2)
```

Quase todas estão a menos de 60, vamos dar um zoom nisso.

```{r}
hist_plot(wine, 'free.sulfur.dioxide', 2) +
  scale_x_continuous(breaks = seq(min(wine$free.sulfur.dioxide), 98, 8)) +
  coord_cartesian(xlim = c(min(wine$free.sulfur.dioxide), 100))
```

A distribuição tem um pico proximo do valor 7. 

Agora comparando para vinhos bons e ruins:

```{r}
h1_fsd <- hist_plot(subset(wine, quality <= 4), 'free.sulfur.dioxide', 5) +
  scale_x_continuous(breaks = seq(min(wine$free.sulfur.dioxide), 82, 5)) +
  coord_cartesian(xlim = c(min(wine$free.sulfur.dioxide), 78)) +
  ggtitle('Vinhos ruins')

h2_fsd <- hist_plot(subset(wine, quality >= 7), 'free.sulfur.dioxide', 5) +
  scale_x_continuous(breaks = seq(min(wine$free.sulfur.dioxide), max(wine$free.sulfur.dioxide), 5)) +
  ggtitle('Vinhos bons')

grid.arrange(h1_fsd, h2_fsd)
```

Para os vinhos ruins vemos uma distribuição mais larga, porem os vinhos bons estão contidos nesse intervalo.

Vamos criar a variavel bound, que é o enxofre total menos o enxofre livre:

```{r}
# we just subtract free SO2 from total SO2

wine$bound.sulfur.dioxide <- wine$total.sulfur.dioxide - wine$free.sulfur.dioxide
```

```{r}
summary(wine$bound.sulfur.dioxide)
```

Agora visualizamos alguns histogramas para ver como se comporta.

```{r}
hist_plot(wine, 'bound.sulfur.dioxide', 4)
```

Temos alguns outliers vamos ver mais proximo.

```{r}
subset(wine, bound.sulfur.dioxide > 200)
```

Temos aqui vinhos de boa qualidade.

Comparando bons com ruins para essa variável:

```{r}
hist_plot(subset(wine, quality <= 4), 'bound.sulfur.dioxide', 8) +
  scale_x_continuous(breaks = seq(min(wine$bound.sulfur.dioxide), 196, 8)) +
  coord_cartesian(xlim = c(min(wine$bound.sulfur.dioxide), 200)) +
  ggtitle('Vinhos ruins')
```

```{r}
hist_plot(subset(wine, quality >= 7), 'bound.sulfur.dioxide', 8) +
  scale_x_continuous(breaks = seq(min(wine$bound.sulfur.dioxide), max(wine$bound.sulfur.dioxide), 8)) +
  ggtitle('Vinhos bons')
```

Vinhos bons tem um pico muito maior e outliers maiores também.

Agora analisando a quantidade total de enxofre:

```{r}
hist_plot(wine, 'total.sulfur.dioxide', 4)
```

Esse histograma mostra 2 pontos de outlier, vamos dar uma olhada neles.

```{r}
subset(wine, total.sulfur.dioxide > 200)
```

são os mesmos vinhos de boa qualidade que obtivemos para o enxofre ligado.

Agora o comparativo das distribuições para vinhos bons e ruins.

```{r}
h1_tsd <- hist_plot(subset(wine, quality <= 4), 'total.sulfur.dioxide', 10) +
  scale_x_continuous(breaks = seq(min(wine$total.sulfur.dioxide), 249, 10)) +
  coord_cartesian(xlim = c(min(wine$total.sulfur.dioxide), 250)) +
  ggtitle('Vinhos ruin')

h2_tsd <- hist_plot(subset(wine, quality >= 7), 'total.sulfur.dioxide', 10) +
  scale_x_continuous(breaks = seq(min(wine$total.sulfur.dioxide), max(wine$total.sulfur.dioxide), 10)) +
  ggtitle('Vinhos bons')

grid.arrange(h1_tsd, h2_tsd)
```

The poor wines histogram peaks at 109 and then at 189, whereas the excellent wines histogram shows two distinct peaks situated fairly close to each other - at 99 and 119. Also, poor wine samples are more spread out across the X axis, and the poor wines distribution seems to have a left tail.

# Análise Univariada

### Qual é a estrutura do conjunto de dados?

O conjunto de dados tem 1599 registros com 11 variáveis (de aspecto químico) sendo elas fixed acidity, volatile acidity, citric acid, residual sugar, chlorides, free sulfur dioxide, total sulfur dioxide, density, pH, sulphates e alcohol + qualidade do vinho (de 0 a 10) reportada por profissionais da área.

### Quais são os principais atributos de interesse deste conjunto de dados?

O atributo de interesse é a qualidade do vinho dado que tal dataset foi construido com o objetivo de fazer uma analise estatistica sobre quais fatores influenciam na qualidade do vinho.

### Quais outros atributos você acha que podem lhe auxiliar na investigação destes atributos de interesse?

Pela analise até o momento a maioria dos fatores contribui para a qualidade do vinho, porém pH, enxofre e cloretos me paraceram mais interessante.

### Você criou novas variáveis a partir dos atributos existentes no conjunto de dados?

Criei, na seção de enxofre, criei a variável bound sulfur que é o enxofre total menos o enxofre livre, sendo esse bound o enxofre ligado a outras moleculas no vinho.

### Dos atributos investigados, distribuições incomuns foram encontradas? Você aplicou operações nos dados para limpá-los, ajustá-los ou mudar a forma dos dados? Se sim, por quê?

Foram encontradas diversas distribuições com outliers e de cauda pesada, os outliers analisei em graficos separadamente e as distribuições de cauda pesada apliquei a função logaritimica tornando minha distribuição normalizada, facilitando a analise


# Seção de Gráficos Bivariados
Nessa seção analisaremos as relações entre as features par a par.

```{r fig.height = 12, fig.width = 15, cache = TRUE, cache.path = "cache/", fig.path = "fig/", Bivariate_Plots}
ggpairs(wine)
```


Temos uma correlação significativa para a qualidade do vinho apenas para a variável alcool, o que a principio desestimula uma analise mais profunda, porém existem relações entre mais variáveis que por enquanto nos estão ocultas, além de transformações que podem ser feitas tornando as relações lineares.

Citando as relações par a par, vemos que algumas variáveis estão bem relacionadas, densidade e acidez fixada, pH e acidez fixada, enxofre ligado e enxofre total e outras não citadas menos relacionadas, variando positivamente e negativamente.

## Scatter plot das correlações positivas

```{r}

scatter_plot <- function(x, y) {
  ggplot(data = wine, aes_string(x = x, y = y)) +
   geom_point(alpha = .25, position = position_jitter(h = 0), size = 1) +
   geom_smooth(method = 'lm')
}
```
```{r}
scatter_plot('density', 'residual.sugar') +
  coord_cartesian(xlim = c(min(wine$density), 1.0025),
                  ylim = c(min(wine$residual.sugar), 25))
```

Esse par apresenta a maior correlação positiva.

```{r}
scatter_plot('density', 'total.sulfur.dioxide') +
  coord_cartesian(xlim = c(min(wine$density), 1.0025),
                  ylim = c(min(wine$total.sulfur.dioxide), 300))
```

```{r}
scatter_plot('density', 'bound.sulfur.dioxide') +
  coord_cartesian(xlim = c(min(wine$density), 1.0025),
                  ylim = c(min(wine$bound.sulfur.dioxide), 250))
```

Para esses outros dois plots vemos dados bem espalhados, sem nenhuma relação não-linear clara.

```{r}
scatter_plot('quality', 'alcohol')
```

Aqui vemos uma correlação positiva, quanto maior a quantidade de alcool, mais provavel o vinho ter uma nota mais alta.

```{r}
scatter_plot('residual.sugar', 'total.sulfur.dioxide') +
  coord_cartesian(xlim = c(min(wine$residual.sugar), 25),
                  ylim = c(min(wine$total.sulfur.dioxide), 300))
```

```{r}
scatter_plot('residual.sugar', 'bound.sulfur.dioxide') +
  coord_cartesian(xlim = c(min(wine$residual.sugar), 25),
                  ylim = c(min(wine$bound.sulfur.dioxide), 250))
```

Esses dois pares tem pouca correlação com entre as variáveis, sendo as distribuições bem concentradas proximo a origem.

## Scatter plot relações negativas

```{r}
scatter_plot('alcohol', 'density') +
  coord_cartesian(ylim = c(min(wine$density), 1.0025)) +
  scale_x_continuous(breaks = seq(8, 14, .5))
```

Aqui a correlação indica que vinhos de maior densidade apresentam menos alcool e de menor densidade mais alcool.

```{r}
scatter_plot('alcohol', 'residual.sugar') +
  coord_cartesian(ylim = c(min(wine$residual.sugar), 25)) +
  scale_x_continuous(breaks = seq(8, 14, .5))
```

Aqui também vemos uma correlação fraca entre alcool e açúcar residual.

```{r}
scatter_plot('alcohol', 'total.sulfur.dioxide') +
  coord_cartesian(ylim = c(min(wine$total.sulfur.dioxide), 300)) +
  scale_x_continuous(breaks = seq(8, 14, .5))
```

```{r}
scatter_plot('alcohol', 'bound.sulfur.dioxide') +
  coord_cartesian(ylim = c(min(wine$bound.sulfur.dioxide), 250)) +
  scale_x_continuous(breaks = seq(8, 14, .5))
```

Aqui a indicios de uma correlação não muito forte entre enxofre ligado e o inverso da quantidade de alcool.

```{r}
scatter_plot('fixed.acidity', 'pH') +
  coord_cartesian(xlim = c(min(wine$fixed.acidity), 10),
                  ylim = c(2.75, 3.75))
```

```{r}
scatter_plot('alcohol', 'chlorides') +
  coord_cartesian(ylim = c(min(wine$chlorides), .2)) +
  scale_x_continuous(breaks = seq(8, 14, .5))
```

Temos aqui duas correlação inversamente fortes, ph e acidez fixada, alcool e cloros.

## Box plots de qualidade

Aqui investigamos as distribuições da relação entre notas e aspecto quimico:

```{r}

box_plot <- function(y) {
  ggplot(data = wine, aes_string(x = 'quality', y = y)) +
    geom_boxplot(aes(group = cut_width(quality, 1))) +
    scale_x_continuous(breaks = seq(min(wine$quality), max(wine$quality)))
}
```

```{r}
# another function for displaying summary of a variable broken down by quality

sum_by_qual <- function(x) {
  by(x, wine$quality, summary)
}
```

### Qualidade e acidez fixada

```{r}
box_plot('fixed.acidity')
```

```{r}
sum_by_qual(wine$fixed.acidity)
```


### Qualidade e acidez volatil

```{r}
box_plot('volatile.acidity')
```

```{r}
sum_by_qual(wine$volatile.acidity)
```


### Qualidade e acidez citrica

```{r}
box_plot('citric.acid')
```

```{r}
sum_by_qual(wine$citric.acid)
```


### Qualidade e açucar residual

```{r}
box_plot('residual.sugar')
```

```{r}
sum_by_qual(wine$residual.sugar)
```


### Qualidade e cloretos

```{r}
box_plot('chlorides')
```

```{r}
sum_by_qual(wine$chlorides)
```

### Qualidade e dioxido de enxofre livre

```{r}
box_plot('free.sulfur.dioxide')
```

```{r}
sum_by_qual(wine$free.sulfur.dioxide)
```


### Qualidade e dioxido de enxofre ligado

```{r}
box_plot('bound.sulfur.dioxide')
```

```{r}
sum_by_qual(wine$bound.sulfur.dioxide)
```

### Qualidade e dioxido de enxofre total

```{r}
box_plot('total.sulfur.dioxide')
```

```{r}
sum_by_qual(wine$total.sulfur.dioxide)
```

### Qualidade e densidade

```{r}
box_plot('density')
```

```{r}
sum_by_qual(wine$density)
```

### Qualidade e pH

```{r}
box_plot('pH')
```

```{r}
sum_by_qual(wine$pH)
```


### Qualidade e sulfatos

```{r}
box_plot('sulphates')
```

```{r}
sum_by_qual(wine$sulphates)
```

### Qualidade e alcool

```{r}
box_plot('alcohol')
```

```{r}
sum_by_qual(wine$alcohol)
```

## Plots de densidade

Fazendo agora um grafico da densidade divididos pela qualidade.

```{r}
density_plot <- function(x, palette) {
  ggplot(data = wine, aes(x = x, color = factor(wine$quality))) +
    geom_density() +
    scale_color_brewer(type = 'seq', palette = palette)
}
```

```{r}
density_plot(wine$density, 'Greens') +
  coord_cartesian(xlim = c(min(wine$density), 1.001)) +
  labs(x = 'wine density') +
  theme_dark()
```

```{r}
density_plot(wine$alcohol, 'Purples') +
  scale_x_continuous(breaks = seq(8, 14, .5)) +
  labs(x = 'alcohol') +
  theme_dark()
```

```{r}
density_plot(wine$residual.sugar, 'Reds') +
  coord_cartesian(xlim = c(0, 25)) +
  labs(x = 'residual sugar') +
  theme_dark() +
  ggtitle('Density of residual sugar by quality grade')
```

In all these plots, we can clearly see a bimodal distribution for the best wines. I guess this effect is due to there being very few wine samples with grade 9 in the dataset that take on just several values. Our analysis might have benefited from a greater number of highest-quality wines, as we could've checked whether this pronounced bimodality has to do with insufficient data or there're some other factors at play.

As for the last density plot for residual sugar, the distributions seem quite skewed - and indeed, in the first section of this analysis, we've found out that the residual sugar distribution has a very heavy right tail. Let's now try rebuilding the same density plot, but with the residual sugar variable log-transformed.

```{r}
density_plot(log10(wine$residual.sugar), 'Reds') +
  labs(x = 'residual sugar') +
  theme_dark() +
  ggtitle('Density of log10(residual sugar) by quality grade')
```

Now it becomes obvious this distribution is actually bimodal across all wine grades! Pretty curious finding that I can't explain right away for the lack of the domain knowledge. It might even be a phenomenon peculiar to Portuguese wines - it's really hard to tell without having more data handy.

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

The strongest positive correlation involving quality is quality vs alcohol (0.436). One particularly interesting thing here is that an upward trend (quality increases as alcohol content grows) holds true only for higher-quality wines, starting from the grade of 6; below this point the trend is actually downward: for wine samples graded 3-5, the lower the alcohol level, the better the wine. The median alcohol value of less than 12 indicates that a wine sample's maximum score is 7, which might help us tell a good wine sample from a poor one.

The most pronounced negative correlation that has to do with our main feature is observed in the pair quality - density (-0.307). The general trend there is a downward one: with each grade, median density decreases a bit, with a notable exception of one group - wine samples of grade 5, which break this trend and actually have the greatest median density of all grades. The exactly same picture can be seen in quality vs bound SO2 (-0.218): grade 5 wines once again break the generally downward trend.

Another interesting pattern was discovered in the pair quality vs volatile acidity (-0.195): median values there seemed to change in a wave-like fashion from one grade to another, going up and down a few times.

One more curious finding was that the residual sugar distribution, which is highly skewed initially, when log-transformed and color-coded by quality, is actually bimodal across all the wine grades, from lowest to highest. As I said above, under the relevant plot, I might be lacking some specialist knowledge to draw the right conclusion based on this fact, or it might just be a peculiarity of Portuguese wines, white ones in particular.

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

Fun fact: positive correlations were dominated by density (3 occurrences out of 6), negative ones by alcohol, featured even more prominently (5 occurrences out of 6). Therefore, it's only natural that these two features produced the most highly correlated pairs (which I'm talking about in more detail in the subsection below), and density had a part in both of them!

Among other things, total SO2 and bound SO2 turned out to be positively correlated with both density and residual sugar. As for the negative correlation, one of the strongest relationships were observed in such pairs as: total SO2 and free SO2 vs alcohol; pH vs fixed acidity; alcohol vs residual sugar and chlorides.

### What was the strongest relationship you found?

Surprisingly enough, the two most pronounced correlations didn't involve the main variable, quality, but instead featured density, which seems to be heavily dependent on both residual sugar and alcohol content. In the former case, the correlation is positive and equals 0.839; in the latter case, the features are negatively correlated (-0.78).

# Multivariate Plots Section

In the previous section, we used box plots to see how different variables are distributed across wine grades and scatter plots to discover interesting pairwise relationships between the features. This section allows us to take our analysis one step further by combining the two techniques and examining what relationships the features display (and how these relationships vary) across wine grades.

## Scatter plots faceted by quality

Let's first take a look at a couple of scatter plots for the features that exhibited the strongest correlation, faceted by quality.

```{r Multivariate_Plots}
# function for building faceted scatter plots

f_scatter_plot <- function(x, y) {
  ggplot(data = wine, aes_string(x = x, y = y)) +
    geom_point(color = 'blue', alpha = .2) +
    geom_smooth(method = 'lm', color = 'red') +
    facet_wrap(~quality)
}
```

```{r}
f_scatter_plot('density', 'residual.sugar') +
  coord_cartesian(xlim = c(min(wine$density), 1.001),
                  ylim = c(min(wine$residual.sugar), 25)) +
  ggtitle('Density vs residual sugar scatter plot faceted by quality')
```

```{r}
f_scatter_plot('density', 'alcohol') +
  coord_cartesian(xlim = c(min(wine$density), 1.001),
                  ylim = c(7.5, 15)) +
  ggtitle('Density vs alcohol scatter plot faceted by quality')
```

Looks like no surprises here. Scatter plots demonstrate the same trends across all wine quality grades: upward for density vs residual sugar and downward for density vs alcohol.

I wonder what plots would look like for less correlated features.

```{r}
f_scatter_plot('alcohol', 'residual.sugar') +
  coord_cartesian(ylim = c(min(wine$residual.sugar), 25)) +
  ggtitle('Alcohol vs residual sugar scatter plot faceted by quality')
```

For the lowest-quality wines, alcohol doesn't seem to be correlated with residual sugar at all, with a negative trend becoming more noticeable towards higher wine grades.

```{r}
f_scatter_plot('alcohol', 'total.sulfur.dioxide') +
  ggtitle('Alcohol vs total SO2 scatter plot faceted by quality')
```

Somewhat similar picture here. In case of the worst and best wines, alcohol and total So2 are much less correlated (if correlated at all) as compared with wine samples of other grades, which all display a more prominent downward trend.

```{r}
f_scatter_plot('density', 'total.sulfur.dioxide') +
  coord_cartesian(xlim = c(min(wine$density), 1.001)) +
  ggtitle('Density vs total SO2 scatter plot faceted by quality')
```

This time the weakest correlation between the features takes place with the best wine samples. In all other cases, an upward trend is obvious.

## Building a simple linear model

We'll now build a pretty straightforward linear model to see how well it can predict wine quality based on the features we've analyzed.

```{r}
m1 <- lm(quality ~ alcohol, data = wine)
m2 <- update(m1, ~ . + residual.sugar)
m3 <- update(m2, ~ . + density)
m4 <- update(m3, ~ . + volatile.acidity)
m5 <- update(m4, ~ . + pH)
m6 <- update(m5, ~ . + sulphates)
m7 <- update(m6, ~ . + free.sulfur.dioxide)
mtable(m1, m2, m3, m4, m5, m6, m7, sdigits = 3)
```

The variables in this linear model can account for 28% of the variance in the quality of white wine.

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

The most prominent correlations we've discovered were in fact so strong that, when faceted by wine quality, the features displayed the same trends across all wine grades: for density vs residual sugar, the trend was always upward, for density vs alcohol always downward.

For other, less correlated features (alcohol vs residual sugar, alcohol vs total SO2, density vstotal SO2), the trend across the wine grades was also the same, with an exception of best or worst wines, or both, whereby features showed little to no correlation whatsoever.

### Were there any interesting or surprising interactions between features?

Since the correlation between density and residual sugar was quite higher than that of density and alcohol (0.839 vs -0.78), I was epsecially interested to see how residual sugar and alcohol were correlated and expected at least a slightly positive correlation. To my surprise, the correlation turned out to be strongly negative (-0.451, second strongest among negative correlations discovered); in fact, it was so strong that a negative downward trend manifested itself across 6 out 7 wine grades represented in the dataset, except for grade 3, where features showed no correlation at all.

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

Yes, I did create a linear model that makes a prediction based on 7 features from the dataset. Further increasing the number of features didn't yield any significant improvement, so I stopped at this value. Surprisingly enough, the model explains a mere 28% of the variance in the target variable, which is quality. It seems like wine quality is not well supported by its physico-chemical properties. Two things to note here: first, quality of prediction could be improved with more data (right now, it's less than 5,000 samples); second, there're some other factors at play, so the model might have benefited from addition of such variables as price of wine, region where it was produced, year it was produced and other things not related to wine chemistry. Trying out other models may also lead to better results. Say, I have a hunch that tree-based methods would do well in this case.

------

# Final Plots and Summary

### Plot One

```{r Plot_One}
ggplot(data = wine, aes(x = quality, y = alcohol)) +
    geom_jitter(alpha = .3) +
    geom_boxplot(aes(group = cut_width(quality, 1)), color = 'red', alpha = .3, outlier.shape = NA) +
    # asterisks mark mean values for each wine grade
    stat_summary(fun.y = mean, geom = 'text', label = '*', size = 10, color = 'blue') +
    scale_x_continuous(breaks = seq(min(wine$quality), max(wine$quality))) +
    scale_y_continuous(breaks = seq(8, 14, .5)) +
    labs(x = 'Wine grade', y = 'Alcohol (% by volume)') +
    ggtitle('Alcohol content across wine grades')
```

### Description One

This box plot supports our finding saying that the strongest positive correlation our main variable of interest is involved in is quality vs alcohol (0.436). An interesting thing here is that for lower wine grades, we can actually observe a negative downward trend that gets reversed only from grade 5 onwards. Thus, for wines of up to grade 5, the lower the alcohol content, the better a wine tends to be; after that wine quality grows linearly with increasing alcohol content.

Moreover, the median (and mean as well) alcohol content of best wines looks significantly different from that of worst wines, which can be used to more or less reliably tell a quality wine from a poor one.

### Plot Two
```{r Plot_Two}
density_plot(wine$residual.sugar, 'Reds') +
  scale_x_log10(breaks = seq(1, 15, 2)) +
  scale_y_continuous(breaks = seq(0, 1.5, .25)) +
  labs(x = 'Residual sugar (grams per liter)', y = 'Density', color = 'Wine grade') +
  theme_dark() +
  ggtitle('Density of residual sugar on log scale by wine grade')
```

### Description Two

When plotted unmodified, the residual sugar distribution is highly skewed and has a long right tail. However, when log-transformed, the distribution becomes bimodal. When I later color-coded the plot, I saw the distribution was in fact bimodal across all the wine grades. Intrigued by this phenomenon, I read a few specialized articles on residual sugar in wines, but couldn't find any explanation that would satisfy me. Therefore I'm inclined to think, for the lack of proof to the contrary, that it's just a regional thing specific to Portuguese wines.

### Plot Three
```{r Plot_Three}
f_scatter_plot('alcohol', 'total.sulfur.dioxide') +
  scale_x_continuous(breaks = seq(8, 14, 1)) +
  labs(x = 'Alcohol (% by volume)', y = 'Total sulfur dioxide (milligrams per liter)') +
  ggtitle('Alcohol vs total sulfur dioxide scatter plot faceted by wine grade')
```

### Description Three

This faceted scatter plot illustrates the third strongest negative correlation discovered during the analysis - alcohol vs total SO2. Each subplot contains a line of best fit that visually reinforces the trend across wine grades. One interesting observation here is that with best and worst wines, the features display little to no correlation whatsoever, whereas for wines of grades 4 through 8, a clearly negative downward trend manifests itself. It might be an indication of the fact that this particular combination of features is a bad candidate for predicting wine quality. Indeed, when I was building a linear model, alcohol turned out to be the best contributor to the overall quality of prediction, whereas total SO2 added absolutely nothing to improve it and therefore was not included in the resulting model.

------

# Reflection

The dataset I've analyzed contains information on almost 5,000 white wines across 11 variables plus the output variable based on sensory data, that is a grade on a scale of 0 to 10 given to each wine sample by professional wine judges. This dataset is restricted to Portuguese wines and contains only their physico-chemical properties.

I began my analysis by building histograms of each feature to understand their distribution. They turned out to be normally distributed, with a few notable exceptions (take residual sugar as an example), where I observed heavy skew and long tails. Log-transforming these variables helped me deal with this abnormality. I also defined thresholds for poor (grade 4 and under) and excellent (grade 8 and over) wines, then subset my dataset using these thresholds and plotted distributions of individual features across poor and excellent wines side by side. This helped me see whether these distributions were very different and identify a few potential candidates that could be useful in telling a low-quality wine from a better one.

I went on to explore pairwise relationships between the features and pick out the most strongly correlated (both positively and negatively) pairs to focus my analysis on them. To my surprise, the main variable of interest - quality - wasn't involved in any of the strongest correlations identified. I built a few scatter plots and included a line of best fit for each of them to more clearly see the general trend in the data points. Then I added a few box plots that reinforced my earlier findings and offered some new insights.

My greatest success was finding out that alcohol content was the most influential feature that could more or less reliably be used to differentiate between poor and excellent wines. Indeed, when I later built a linear model to predict a wine grade, this feature alone contributed over 70% to the overall prediction quality.

In the final part of my analysis, I used wine grades to color-code and facet a few plots that I'd built previously to see if any variables reinforce each other across any of the wine grades. The main finding here was that in the two most strongly correlated pairs the corelation was so pronounced that the trend stayed the same across all wine grades: it was always upward for density vs residual sugar and downward for alcohol vs density. The situation was a bit different for more weakly correlated pairs: the trend did stay the same across most wine grades, but with worst or best wines, the features I was analyzing displayed little to no correlation at all (for example, alcohol vs total SO2), which signaled these combinations were probably not the best predictors of wine quality. I tested these findings when building a linear model and excluded the worst contributors from the final version.

I've also bumped into a couple of obstacles along the way. First, I found out that the residual sugar distribution, when log-transformed, is bimodal across all wine grades. I've been struggling to explain this phenomenon for some time and even read a few specialized articles on the topic, but found no satisfactory explanation so far. So I'm inclined to believe this phenomenon is specific to Portuguese wines, since that's what I've been analyzing all along.

Another thing I had difficulties with was the linear model that I'd built. It was able to explain only 28% of the variance in wine quality, which I found to be a pretty poor result. At first, I thought I was doing something wrong and actually spent a couple of days trying to engineer new features and combine them in various ways (to no avail), but then I realized that some other factors were at play and physico-chemical properties alone were not enough of a quality predictor.

And this realization leads me to suggestions on how to improve this analysis. First and foremost, more data would be nice. 5,000 wine samples is alright, but given the number of wines in the world, it's just a drop in the ocean. Besides, the dataset is restricted to only Portuguese wines, which significantly limits its value and ability to represent the whole population. Second, as I mentioned above, there must be some other features that heavily influence wine quality. Better results might have been obtained if we had information about a region where a wine was produced, the year it was produced, grape type, selling price and wine brand, to name a few. Also, it might be a good idea to test other kinds of models and see how they fare against each other. I guess more powerful models, like SVM or tree-based methods, could have demonstrated impressive results.
